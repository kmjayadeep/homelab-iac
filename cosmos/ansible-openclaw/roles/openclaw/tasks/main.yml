---
- name: Install base packages
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - git
      - gnupg
    state: present
    update_cache: true

- name: Download NodeSource GPG key
  ansible.builtin.get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /usr/share/keyrings/nodesource.gpg.key
    mode: "0644"

- name: Dearmor NodeSource GPG key
  ansible.builtin.command: >-
    gpg --dearmor -o /usr/share/keyrings/nodesource.gpg /usr/share/keyrings/nodesource.gpg.key
  args:
    creates: /usr/share/keyrings/nodesource.gpg

- name: Add NodeSource repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_version }} nodistro main"
    filename: nodesource
    state: present

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true

- name: Ensure OpenClaw group exists
  ansible.builtin.group:
    name: "{{ openclaw_group }}"
    state: present

- name: Ensure OpenClaw user exists
  ansible.builtin.user:
    name: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    shell: /bin/bash
    create_home: true

- name: Install SSH authorized keys for OpenClaw user
  ansible.builtin.authorized_key:
    user: "{{ openclaw_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ openclaw_authorized_keys }}"

- name: Install OpenClaw via npm
  block:
    - name: Get npm global root
      ansible.builtin.command: npm root -g
      register: openclaw_npm_root
      changed_when: false

    - name: Check if OpenClaw is installed
      ansible.builtin.command: command -v openclaw
      register: openclaw_binary
      changed_when: false
      failed_when: false

    - name: Remove existing OpenClaw install when forced
      ansible.builtin.file:
        path: "{{ openclaw_npm_root.stdout }}/openclaw"
        state: absent
      when: openclaw_force_reinstall

    - name: Install OpenClaw via npm
      community.general.npm:
        name: "{{ openclaw_npm_name }}"
        global: true
        state: present
      environment: "{{ openclaw_npm_env }}"
      when: openclaw_binary.rc != 0 or openclaw_force_reinstall
  rescue:
    - name: Clean OpenClaw npm directory after failure
      ansible.builtin.file:
        path: "{{ openclaw_npm_root.stdout }}/openclaw"
        state: absent

    - name: Retry OpenClaw install via npm
      community.general.npm:
        name: "{{ openclaw_npm_name }}"
        global: true
        state: present
      environment: "{{ openclaw_npm_env }}"

- name: Install Nginx
  ansible.builtin.apt:
    name: nginx
    state: present

- name: Install Certbot and Cloudflare plugin
  ansible.builtin.apt:
    name:
      - certbot
      - python3-certbot-dns-cloudflare
    state: present

- name: Ensure Cloudflare token and email are set
  ansible.builtin.assert:
    that:
      - cloudflare_api_token | length > 0
      - letsencrypt_email | length > 0
    fail_msg: "CLOUDFLARE_API_TOKEN and LETSENCRYPT_EMAIL must be set in the environment."

- name: Install Cloudflare credentials for Certbot
  ansible.builtin.template:
    src: cloudflare.ini.j2
    dest: /etc/letsencrypt/cloudflare.ini
    owner: root
    group: root
    mode: "0600"

- name: Obtain Let's Encrypt certificate via DNS challenge
  ansible.builtin.command: >-
    certbot certonly
    --dns-cloudflare
    --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini
    --non-interactive
    --agree-tos
    -m {{ letsencrypt_email }}
    -d {{ openclaw_cert_domain }}
  args:
    creates: "/etc/letsencrypt/live/{{ openclaw_cert_domain }}/fullchain.pem"

- name: Install Certbot deploy hook to reload Nginx
  ansible.builtin.copy:
    dest: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
    mode: "0755"
    owner: root
    group: root
    content: |-
      #!/usr/bin/env bash
      set -e
      systemctl reload nginx

- name: Configure Nginx for OpenClaw dashboard
  ansible.builtin.template:
    src: openclaw-nginx.conf.j2
    dest: /etc/nginx/sites-available/openclaw.conf
    mode: "0644"
  notify: Reload Nginx

- name: Enable OpenClaw Nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/openclaw.conf
    dest: /etc/nginx/sites-enabled/openclaw.conf
    state: link
  notify: Reload Nginx

- name: Ensure Nginx is running
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true

- name: Print manual onboarding steps
  ansible.builtin.debug:
    msg:
      - "OpenClaw installed. Run onboarding manually:"
      - "sudo -i -u {{ openclaw_user }}"
      - "openclaw onboard --install-daemon"
